---
import { getSession } from "auth-astro/server";

const session = await getSession(Astro.request);
const isLoggedIn = !!session?.user;
---

{isLoggedIn ? (
  <div class="message-input-container mt-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md">
    <textarea
      id="message-content"
      class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white resize-y focus:outline-none focus:ring-2 focus:ring-blue-500"
      placeholder="Write your message here..."
      rows={3}
    ></textarea>
    <button
      id="send-message-button"
      class="mt-3 px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500"
    >
      Send Message
    </button>
  </div>
) : (
  <p class="text-center text-gray-500 mt-4">Please log in to send messages.</p>
)}

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const sendMessageButton = document.getElementById("send-message-button");
    const messageContentInput = document.getElementById("message-content") as HTMLTextAreaElement;

    if (sendMessageButton && messageContentInput) {
      sendMessageButton.addEventListener("click", async () => {
        const content = messageContentInput.value.trim();

        if (content) {
          try {
            const response = await fetch("/api/messages", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ content }),
            });

            if (response.ok) {
              messageContentInput.value = ""; // Clear the input
              // Optionally, trigger a refresh of the message list
              window.location.reload(); // Simple reload for now
            } else {
              const errorData = await response.json();
              alert(`Failed to send message: ${errorData.message}`);
            }
          } catch (error) {
            console.error("Error sending message:", error);
            alert("An error occurred while sending the message.");
          }
        } else {
          alert("Message content cannot be empty.");
        }
      });
    }
  });
</script>
